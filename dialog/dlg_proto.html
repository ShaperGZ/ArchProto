<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prototype</title>
    <link rel="stylesheet" type="text/css"href="ArchProto.css">
    <script src="d3.js"></script>

    <script src="chart_AptScore.js"></script>
    <script src="jsChart.js"></script>
</head>
<body>
<table>
    <tb>
        <tr>
            <td>
                <svg width="120" height="120"></svg>
            </td>
            <td>
                <table id="score_ratio_sliders">
                </table>
            </td>
        </tr>
    </tb>
</table>
<form>
    <!--customize composition-->
    <span id="title" class="titles" > Composition Customization</span><br>
    <table >
        <tbody>
            <tr>
                <!--check boxes-->
                <th>
                    <table>
                    <tb>
                        <tr>
                            <td><span class="contents" id="sp_double" > D </span></td>
                            <td><span class="contents" id="sp_L-shape"> L </span></td>
                            <td><span class="contents" id="sp_U-shape"> U </span></td>
                            <td><span class="contents" id="sp_O-shape"> O </span></td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" id="cb_double"  onclick="on_checkbox_clicked(this)"/></td>
                            <td><input type="checkbox" id="cb_L-shape" onclick="on_checkbox_clicked(this)"/></td>
                            <td><input type="checkbox" id="cb_U-shape" onclick="on_checkbox_clicked(this)"/></td>
                            <td><input type="checkbox" id="cb_O-shape" onclick="on_checkbox_clicked(this)"/></td>
                        </tr>
                    </tb>
                    </table>
                </th>
                <!--view modes-->
                <th>
                    <table id="view_mode_bt_container">
                    </table>
                </th>
            </tr>

        </tbody>
    </table>
    <div id="threejs_container"></div>
    <div style="overflow-y: scroll; width:260px; height:500px;">
        <div id="attribute_table"></div>
    </div>
</form>
<script>
    scoreNames=[
        "Efficiency",
        "SouthUnit",
        "FireCompt",
        "VertlEvac",
        "Undefined",
        "Undefined"
    ]
    scoreData=[
        {"name":scoreNames[0],"value":0.5, "flag":true, "weight":1.6,"description":""},
        {"name":scoreNames[1],"value":0.5, "flag":true, "weight":0.9,"description":""},
        {"name":scoreNames[2],"value":0.5, "flag":true, "weight":1,"description":""},
        {"name":scoreNames[3],"value":0.5, "flag":true, "weight":0.8,"description":""},
        {"name":scoreNames[4],"value":0.75, "flag":true, "weight":0.4,"description":""},
        {"name":scoreNames[5],"value":0.95, "flag":true, "weight":0.3,"description":""},
    ];

    var colorRatio=d3.scale.linear()
        .domain([0.1,1,1.9])
        .range(["#9C4C32","#FFE49B","#5187CB"]);



    function logData(){
        txt=""
        scoreData.forEach(function(d){
            n=d.name;
            v=d.value;
            f=d.flag;
            txt += n + " , " + v + " , "+ f + "\n";
        });
        console.log(txt);
    };

    function setScoreDescription(key,value){
        index=scoreNames.indexOf(key);
        if(index>=0){
            scoreData[index].description=value;
        }
    }
    function setScoreDescriptions(datastring){
        console.log('setScoreDescriptions'+datastring)
        items=datastring.split(",");
        items.forEach(function(item){
            kv=item.split('=>');
            setScoreDescription(kv[0],kv[1]);
        });
    }

    function setScoreValue(key,value,invalidate=true){
        index=scoreNames.indexOf(key);
        if(index>=0){
            if(value >= scoreData[index].value)
                scoreData[index].flag=true;
            else
                scoreData[index].flag=false;
            scoreData[index].value=value;
            if (invalidate) invalidateChart();
            return true;
        }
        return false;
    }
    function setScoreValues(datastring){
        // data string sampple:
        // "efficiency=>0.5,southUnits=>0.6"
        items=datastring.split(",");
        items.forEach(function(item){
            kv=item.split('=>');
            v=parseFloat(kv[1])
            setScoreValue(kv[0],v,false);
        });
        invalidateChart()
    }
    function invalidateChart(){
        chartMain.invalidate(scoreData);
    }

    svg=d3.select("body").select("svg");
    chartMain=new ChartAptScore(svg,scoreData);
    // chartMain.create();

    function on_checkbox_clicked(obj){
        console.log('checkobx clicked')
        checkIds=['cb_double','cb_L-shape','cb_U-shape','cb_O-shape']
        params=""
        for(var i in checkIds){
            id=checkIds[i]
            var cb= document.getElementById(id);
            value=cb.checked;
            params += id + '=>' + value.toString() + ','
        }
        var msg='skp:set_check_boxes@'+params;
        window.location=msg;
        // window.location= 'skp:checkbox_clicked@'+params;
    }
    function set_checkboxes(data){
        //sample data:
        //'double=>true,L-shape=>false'
        data=data.split(',')
        data.forEach(function(d){
            kv=d.split('=>');
            k=kv[0];
            check=false;
            if (kv[1]=="true") check = true;
            id='cb_'+k
            console.log("id="+id)
            obj=document.getElementById('cb_'+k);
            if (obj!=null){
                obj.checked=check;
            }
            else{
                console.log("unable to select with id:"+id);
            }
        });

    }
    function fade_element(key){
        obj=document.getElementById(key);
        obj.style.color="lightgrey";
    }
    function unfade_element(key){
        obj=document.getElementById(key);
        obj.style.color="black";
    }
    function set_param(key,value){
        obj=document.getElementById(key);
        console.log(obj.type);
        if (obj.type=='checkbox'){
            obj.checked=value;
        }
        else if (obj.type=='text'){
            obj.value = value;
        }
        else{
            obj.innerHTML=value;
        }
    }
    // fade_element("sp_O-shape")
    // set_param('title','My New Title')

    function regenAttributeTable(strdata){
        // sample data:
        // wd_width=>3.0;p_apt_serviced=>[1.0,1.0,0.0,1.0]
        var strs=strdata.split(';')
        var data=[]
        strs.forEach(function(s){
            kv=s.split("=>");
            data.push({"name":kv[0],"value":kv[1]});
        });


        tableBB.clearRows();
        tableBB.addRows(data);
        previousData=data
    }

    function get_scoreData_index(key="name",val){
        var counter=0
        scoreData.forEach(function(d){
            if (d[key]==val)
                return counter;
            counter+=1;
        })
        return -1;
    }

    function gen_score_ratio_sliders(){
        var container=document.getElementById("score_ratio_sliders")
        var tb=document.createElement("tb");
        container.appendChild(tb);
        scoreData.forEach(function(d,i){
            var name=d.name
            var weight=d.weight;
            var tr=document.createElement("tr");
            tb.appendChild(tr)

            var span=document.createElement("span")
            span.className="contents"
            span.innerHTML=name;
            var index=i
            span.onclick=function(){
                console.log(scoreData[index].description);
            }

            var input=document.createElement("input");
            input.type="text";
            input.className="contents"
            input.value=d.weight;
            input.style.background=colorRatio(d.weight);
            input.size=1;
            // input.min=0.1;
            // input.max=1.9;
            input.step=0.1;
            input.addEventListener("wheel",function(e){
                var val= parseFloat(input.value)
                if(e.wheelDelta>0)
                    val+=0.1;
                else if(e.wheelDelta<0)
                    val-=0.1;
                val=clampWeight(val)
                input.value=val;
                input.style.background=colorRatio(val);
                scoreData[i].weight=val;
                invalidateChart()
            });
            input.onkeydown=function(key){
                console.log(key.keyCode);
                var val= parseFloat(input.value)
                if (key.keyCode==38){
                    //up
                    val+=0.1;
                }
                else if(key.keyCode==40){
                    //down
                    val-=0.1;
                }
                else if(key.keyCode==27){
                    //ESC
                    val=1;
                }
                val=clampWeight(val)
                input.value=val;
                input.style.background=colorRatio(val);
                // console.log("sliding val:"+input.value);
                scoreData[i].weight=val;
                invalidateChart();
            }
            // input.onchange=function(e){
            //     console.log("sliding val:"+input.value);
            // }

            var td_span=document.createElement("td")
            var td_input=document.createElement("td")
            td_span.appendChild(span)
            td_input.appendChild(input)
            tr.appendChild(td_span)
            tr.appendChild(td_input)
        });
    }

    function clampWeight(w) {
        if (w>1.9) return 1.9;
        if (w<0) return 0;
        return w;
    }

    function gen_view_mode_buttons(){
        var table=document.getElementById("view_mode_bt_container");
        var tb=document.createElement('tb');
        var tr=document.createElement('tr');
        tb.appendChild(tr);
        table.appendChild(tb);

        var buttonNames=['Norm',"Ornt","Unit"];
        for (var i in buttonNames){
            var name=buttonNames[i];
            var td=document.createElement('td');
            var bt=document.createElement('button');
            bt.className='contents';
            bt.type='button';
            bt.innerHTML=name;
            bt.style.height=bt.style.width='40px';
            if(name=='Norm') bt.onclick=viewMode_Norm;
            else if(name=='Ornt') bt.onclick=viewMode_Ornt;
            else if(name=='Unit') bt.onclick=viewMode_Unit;
            td.appendChild(bt);
            tr.appendChild(td);
        }




    }

    function viewMode_Norm(){
        console.log("normal mode")
        window.location='skp:set_view_mode_norm'
    }
    function viewMode_Ornt(){
        console.log("orientation mode")
        window.location='skp:set_view_mode_ornt'
    }
    function viewMode_Unit(){
        console.log("unit mode")
        window.location='skp:set_view_mode_unit'
    }
    function skp_log(msg){
        window.location='skp:log@'+msg
    }

    function update_model_from_ui(){
        console.log('update_model_from_ui')
        skp_log("update model from ui")
        // 1 fetch checkbox states
        //   example data:
        //   'cb_double=>true,cb_L-shape=>true'
        checkIds=['cb_double','cb_L-shape','cb_U-shape','cb_O-shape']
        params=""
        for(var i in checkIds){
            id=checkIds[i]
            var cb= document.getElementById(id);
            value=cb.checked;
            params += id + '=>' + value.toString() + ','
        }
        var msg='skp:set_check_boxes@'+params
        console.log(msg)
        window.location.assign(msg);

        // 2 fetch BuildingBlox textbox (tableBB) states
        var strdata=""
        var trs=tableBB.table.getElementsByTagName("tr")
        // console.log("trs.length="+trs.length)
        for(var i=0;i<trs.length;i++){
            var tr=trs[i]
            var span=tr.getElementsByTagName("span")[0]
            var input=tr.getElementsByTagName("input")[0]
            var name=span.innerHTML;
            var value=input.value
            strdata+=name+"=>"+value+";"
        }
        var msg='skp:set_gp_attributes@'+strdata;
        // console.log(msg)
        window.location.assign(msg);

        // 3 invalidate model
        msg='skp:invalidate_model@';
        window.location.assign(msg);
        window.location.assign('skp:log@this is the last line')
    }

    function set_gp_attributes_on_value_entry(name,value){
        // when "enter" is pressed, record ALL values on the table
        // and send them to skp
        // the function input "name,value" becomes useless

        var strdata=""
        var trs=tableBB.table.getElementsByTagName("tr")
        console.log("trs.length="+trs.length)
        for(var i=0;i<trs.length;i++){
            var tr=trs[i]
            var span=tr.getElementsByTagName("span")[0]
            var input=tr.getElementsByTagName("input")[0]
            var name=span.innerHTML;
            var value=input.value
            strdata+=name+"=>"+value+";"
        }

        var msg='skp:set_gp_attributes@'+strdata;
        console.log(msg)
        window.location=msg;
    }

    // tabeBBContainer=document.getElementById("attribute_table");
    // tableBB=new TableSpanInput(tableBBContainer);
    previousData=null;
    tableBB=new TableSpanInput(document.getElementById("attribute_table"));
    tableBB.onValueChange=set_gp_attributes_on_value_entry;


    gen_score_ratio_sliders()
    gen_view_mode_buttons()
</script>
<script src="threejs/three.js"></script>
<!--<script src="threejs/controls/DragControls.js"></script>-->
<script src="threejs/controls/TrackballControls.js"></script>
<script src="threejs/controls/OrbitControls.js"></script>
<script src="threejsViewer.js"></script>
</body>
</html>